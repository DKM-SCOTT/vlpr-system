<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Analytics - VLPR System</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        background: #f8f9fa;
      }

      .navbar {
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .analytics-card {
        border: none;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
      }

      .chart-container {
        position: relative;
        height: 300px;
        margin: 20px 0;
      }

      .metric-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 25px;
        text-align: center;
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
      }

      .metric-value {
        font-size: 36px;
        font-weight: bold;
        margin: 10px 0;
      }

      .metric-label {
        font-size: 14px;
        opacity: 0.9;
      }
    </style>
  </head>
  <body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container">
        <a class="navbar-brand" href="/">
          <i class="fas fa-car"></i> VLPR System
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('index') }}">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('dashboard') }}"
                >Dashboard</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('detect') }}">Detect</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('search') }}">Search</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="{{ url_for('analytics') }}"
                >Analytics</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('profile') }}">Profile</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('logout') }}">Logout</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="container py-5">
      <!-- Metrics Row -->
      <div class="row mb-4">
        <div class="col-md-4">
          <div class="metric-card">
            <i class="fas fa-images fa-2x mb-3"></i>
            <div class="metric-value">{{ total_plates }}</div>
            <div class="metric-label">Total Detections</div>
          </div>
        </div>
        <div class="col-md-4">
          <div
            class="metric-card"
            style="background: linear-gradient(135deg, #43e97b, #38f9d7)"
          >
            <i class="fas fa-calendar-check fa-2x mb-3"></i>
            <div class="metric-value">{{ dates|length }}</div>
            <div class="metric-label">Active Days</div>
          </div>
        </div>
        <div class="col-md-4">
          <div
            class="metric-card"
            style="background: linear-gradient(135deg, #fa709a, #fee140)"
          >
            <i class="fas fa-chart-line fa-2x mb-3"></i>
            <div class="metric-value">
              {{ "%.1f"|format((counts|sum / dates|length) if dates else 0) }}
            </div>
            <div class="metric-label">Avg Daily</div>
          </div>
        </div>
      </div>

      <!-- Charts Row -->
      <div class="row">
        <div class="col-md-6">
          <div class="card analytics-card">
            <div class="card-header bg-white py-3">
              <h5 class="mb-0">
                <i class="fas fa-chart-line me-2 text-primary"></i>Detection
                Trends
              </h5>
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="trendsChart"></canvas>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="card analytics-card">
            <div class="card-header bg-white py-3">
              <h5 class="mb-0">
                <i class="fas fa-chart-pie me-2 text-primary"></i>Confidence
                Distribution
              </h5>
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="confidenceChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Activity Table -->
      <div class="card analytics-card mt-4">
        <div class="card-header bg-white py-3">
          <h5 class="mb-0">
            <i class="fas fa-table me-2 text-primary"></i>Detection History
          </h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Detections</th>
                  <th>Avg Confidence</th>
                </tr>
              </thead>
              <tbody>
                {% for i in range(dates|length) %}
                <tr>
                  <td>{{ dates[i] }}</td>
                  <td>
                    <span class="badge bg-primary">{{ counts[i] }}</span>
                  </td>
                  <td>
                    <div class="progress" style="height: 8px; width: 150px">
                      <div
                        class="progress-bar bg-success"
                        style="width: {{ (counts[i] / counts|max * 100) if counts else 0 }}%;"
                      ></div>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Trends Chart
      const ctx1 = document.getElementById('trendsChart').getContext('2d');
      new Chart(ctx1, {
          type: 'line',
          data: {
              labels: {{ dates|tojson }},
              datasets: [{
                  label: 'Detections',
                  data: {{ counts|tojson }},
                  borderColor: '#667eea',
                  backgroundColor: 'rgba(102, 126, 234, 0.1)',
                  tension: 0.4,
                  fill: true
              }]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                  legend: {
                      display: false
                  }
              },
              scales: {
                  y: {
                      beginAtZero: true,
                      ticks: {
                          stepSize: 1
                      }
                  }
              }
          }
      });

      // Confidence Chart
      const ctx2 = document.getElementById('confidenceChart').getContext('2d');
      const confidences = {{ confidences|tojson }};
      const bins = [0, 0, 0, 0, 0]; // 0-60, 60-70, 70-80, 80-90, 90-100

      confidences.forEach(c => {
          if (c < 0.6) bins[0]++;
          else if (c < 0.7) bins[1]++;
          else if (c < 0.8) bins[2]++;
          else if (c < 0.9) bins[3]++;
          else bins[4]++;
      });

      new Chart(ctx2, {
          type: 'doughnut',
          data: {
              labels: ['<60%', '60-70%', '70-80%', '80-90%', '90-100%'],
              datasets: [{
                  data: bins,
                  backgroundColor: [
                      '#ff6b6b',
                      '#feca57',
                      '#48dbfb',
                      '#1dd1a1',
                      '#5f27cd'
                  ]
              }]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                  legend: {
                      position: 'bottom'
                  }
              }
          }
      });
    </script>
  </body>
</html>
